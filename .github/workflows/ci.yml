name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  NIGHTLY_VERSION: nightly-2026-02-06
  CMAKE_MACOS: ""

jobs:
  # ── Change Detection ────────────────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.result.outputs.code }}
      skip: ${{ steps.skip.outputs.skip }}
    steps:
      - uses: actions/checkout@v6

      - name: Check for [no ci] in commit message
        id: skip
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message || github.event.pull_request.title }}
        run: |
          if echo "$COMMIT_MSG" | grep -qiF '[no ci]'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: dorny/paths-filter@v3
        if: steps.skip.outputs.skip != 'true'
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'build.rs'
              - 'fuzz/**'
              - 'cmake/**'
              - 'deploy/**'
              - '.github/workflows/**'
              - '.cargo/**'

      - name: Set code output
        id: result
        run: |
          if [[ "${{ steps.skip.outputs.skip }}" == "true" ]]; then
            echo "code=false" >> "$GITHUB_OUTPUT"
          else
            echo "code=${{ steps.filter.outputs.code }}" >> "$GITHUB_OUTPUT"
          fi

  # ── Compile (Debug) ──────────────────────────────────────────────────
  compile-debug:
    name: Compile Debug (${{ matrix.name }})
    needs: [changes]
    if: needs.changes.outputs.code == 'true'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            runner: ubuntu-latest
          - name: macos
            runner: macos-15
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-debug-${{ runner.os }}-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-debug-${{ runner.os }}-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: command -v cmake || brew install cmake

      - name: Build (all features + timings)
        run: cargo build --all-targets --all-features --timings
        env:
          CMAKE_PROJECT_INCLUDE: ${{ runner.os == 'macOS' && format('{0}/cmake/disable-ggml-native.cmake', github.workspace) || '' }}

      - name: Build without optional channels
        run: cargo build --no-default-features
        env:
          CMAKE_PROJECT_INCLUDE: ${{ runner.os == 'macOS' && format('{0}/cmake/disable-ggml-native.cmake', github.workspace) || '' }}

      - name: Upload build timings
        uses: actions/upload-artifact@v7
        with:
          name: build-timings-${{ matrix.name }}
          path: target/cargo-timings/cargo-timing.html

      - name: Prune incremental cache
        run: rm -rf target/debug/incremental/

  # ── Compile (Release, Linux) ─────────────────────────────────────────
  compile-release-linux:
    name: Compile Release (linux)
    needs: [changes]
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-release-linux-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-release-linux-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Build release
        run: cargo build --release --target x86_64-unknown-linux-gnu
        env:
          SOURCE_DATE_EPOCH: "1"

      - name: Prune incremental cache
        run: rm -rf target/x86_64-unknown-linux-gnu/release/incremental/

  # ── Quick Checks (no compilation) ────────────────────────────────────
  check:
    name: Format & Advisories
    needs: [changes]
    if: needs.changes.outputs.skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}
          components: rustfmt

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny

      - name: Check formatting
        run: cargo fmt -- --check

      - name: cargo-deny advisories
        run: cargo deny check advisories

      - name: Check generated docs are up to date
        run: |
          python3 docs/build.py
          if ! git diff --quiet -- docs/; then
            echo "::error::Generated docs are stale. Run 'python3 docs/build.py' and commit."
            git diff --stat -- docs/
            exit 1
          fi

  # ── Clippy ─────────────────────────────────────────────────────────
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: [changes, compile-debug]
    if: needs.changes.outputs.code == 'true'
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}
          components: clippy

      - name: Install tools
        uses: taiki-e/install-action@v2
        with:
          tool: clippy-sarif,sarif-fmt

      - name: Restore cargo cache
        uses: actions/cache/restore@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-debug-${{ runner.os }}-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-debug-${{ runner.os }}-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Clippy (SARIF)
        run: >
          cargo clippy --all-targets --all-features --message-format=json
          | clippy-sarif
          | tee clippy-results.sarif
          | sarif-fmt
        continue-on-error: true

      - name: Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: clippy-results.sarif
          wait-for-processing: true
        continue-on-error: true

      - name: Clippy (fail on warnings)
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ── Unit Tests ──────────────────────────────────────────────────────
  test-unit:
    name: Unit Tests (${{ matrix.name }})
    needs: [changes, compile-debug]
    if: needs.changes.outputs.code == 'true'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            runner: ubuntu-latest
          - name: macos
            runner: macos-15
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}

      - name: Install nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Restore cargo cache
        uses: actions/cache/restore@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-debug-${{ runner.os }}-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-debug-${{ runner.os }}-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: command -v cmake || brew install cmake

      - name: Run unit tests
        run: cargo nextest run --lib --profile default
        env:
          CMAKE_PROJECT_INCLUDE: ${{ runner.os == 'macOS' && format('{0}/cmake/disable-ggml-native.cmake', github.workspace) || '' }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: junit-unit-${{ matrix.name }}
          path: target/nextest/default/junit-unit.xml
          if-no-files-found: warn

  # ── Integration Tests ───────────────────────────────────────────────
  test-integration:
    name: Integration Tests (${{ matrix.name }})
    needs: [changes, compile-debug]
    if: needs.changes.outputs.code == 'true'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            runner: ubuntu-latest
          - name: macos
            runner: macos-15
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}

      - name: Install nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Restore cargo cache
        uses: actions/cache/restore@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-debug-${{ runner.os }}-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-debug-${{ runner.os }}-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: command -v cmake || brew install cmake

      - name: Run integration tests
        run: >
          cargo nextest run --profile integration
          --test session_management
          --test cron_jobs
          --test tool_registry
          --test message_flow
          --test config_validation
          --test context_and_skills
          --test error_handling
          --test filesystem_tools
          --test memory_integration
          --test multi_turn_session
          --test shell_exec
          --test tool_context_caching
          --test compaction_integration
          --test safety_integration
        env:
          OXICRAB_HOME: ${{ runner.temp }}/oxicrab-test
          CMAKE_PROJECT_INCLUDE: ${{ runner.os == 'macOS' && format('{0}/cmake/disable-ggml-native.cmake', github.workspace) || '' }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: junit-integration-${{ matrix.name }}
          path: target/nextest/integration/junit-integration.xml
          if-no-files-found: warn

  # ── Test Results ────────────────────────────────────────────────────
  test-results:
    name: Test Results
    runs-on: ubuntu-latest
    needs: [changes, test-unit, test-integration]
    if: always() && needs.changes.outputs.code == 'true'
    permissions:
      checks: write
      pull-requests: write
    steps:
      - name: Download all test artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: junit-*
          merge-multiple: true

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: "**/*.xml"
          check_name: Test Results
          comment_mode: off

  # ── Coverage ────────────────────────────────────────────────────────
  coverage:
    name: Coverage
    needs: [changes]
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Cache cargo (coverage)
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-coverage-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-coverage-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Generate coverage
        run: >
          cargo llvm-cov
          --all-features
          --workspace
          --lcov
          --output-path lcov.info
          --
          --test-threads=1
        env:
          OXICRAB_HOME: ${{ runner.temp }}/oxicrab-test

      - name: Upload to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          file: lcov.info
        continue-on-error: true

  # ── Binary Size ─────────────────────────────────────────────────────
  binary-size:
    name: Binary Size
    runs-on: ubuntu-latest
    needs: [changes, compile-release-linux]
    if: needs.changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Restore cargo cache
        uses: actions/cache/restore@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-release-linux-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-release-linux-${{ env.NIGHTLY_VERSION }}-

      - name: Measure binary size
        id: size
        run: |
          SIZE=$(stat -c%s target/x86_64-unknown-linux-gnu/release/oxicrab)
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
          echo "bytes=$SIZE" >> "$GITHUB_OUTPUT"
          echo "mb=$SIZE_MB" >> "$GITHUB_OUTPUT"

      - name: Restore baseline size
        if: github.event_name == 'pull_request'
        id: baseline
        uses: actions/cache/restore@v5
        with:
          path: baseline-binary-size.txt
          key: binary-size-baseline-
          restore-keys: binary-size-baseline-

      - name: Compare with baseline
        if: github.event_name == 'pull_request' && steps.baseline.outputs.cache-hit == 'true'
        run: |
          BASELINE=$(cat baseline-binary-size.txt)
          CURRENT=${{ steps.size.outputs.bytes }}
          DELTA=$((CURRENT - BASELINE))
          DELTA_KB=$(echo "scale=1; $DELTA / 1024" | bc)
          if [ $DELTA -gt 0 ]; then
            SIGN="+"
          else
            SIGN=""
          fi
          echo "### Binary Size" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Current | ${{ steps.size.outputs.mb }} MB |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Baseline | $(echo "scale=2; $BASELINE / 1048576" | bc) MB |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Delta | ${SIGN}${DELTA_KB} KB |" >> "$GITHUB_STEP_SUMMARY"

      - name: Report size (no baseline)
        if: github.event_name != 'pull_request' || steps.baseline.outputs.cache-hit != 'true'
        run: |
          echo "### Binary Size" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | ${{ steps.size.outputs.mb }} MB |" >> "$GITHUB_STEP_SUMMARY"

      - name: Save baseline (main only)
        if: github.ref == 'refs/heads/main'
        run: echo "${{ steps.size.outputs.bytes }}" > baseline-binary-size.txt

      - name: Cache baseline
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v5
        with:
          path: baseline-binary-size.txt
          key: binary-size-baseline-${{ github.sha }}

  # ── Package (Linux) ─────────────────────────────────────────────────
  package-linux:
    name: Package (linux)
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-package-linux-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-package-linux-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Build release binary
        run: cargo build --release --target x86_64-unknown-linux-gnu
        env:
          SOURCE_DATE_EPOCH: "1"

      - name: Build DEB package
        run: |
          cargo install cargo-deb --force
          cargo deb --no-build --target x86_64-unknown-linux-gnu
          cp target/x86_64-unknown-linux-gnu/debian/*.deb .

      - name: Validate DEB package
        run: |
          sudo apt-get install -y lintian
          lintian --tag-display-limit 0 *.deb || true
          # Fail on errors (E:), allow warnings (W:) and info (I:)
          ! lintian *.deb 2>&1 | grep -q '^E:'

      - name: Build RPM package
        run: |
          cargo install cargo-generate-rpm --force
          cargo generate-rpm --target x86_64-unknown-linux-gnu
          cp target/x86_64-unknown-linux-gnu/generate-rpm/*.rpm .

      - name: Validate RPM package
        run: |
          sudo apt-get install -y rpmlint
          rpmlint -c deploy/rpm/rpmlint.toml *.rpm
          # Log contents for review
          rpm -qpl *.rpm || true

  # ── Package (macOS) ─────────────────────────────────────────────────
  package-macos:
    name: Package (macos)
    needs: [changes]
    if: needs.changes.outputs.code == 'true'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-package-macOS-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-package-macOS-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies
        run: command -v cmake || brew install cmake

      - name: Build release binary
        run: cargo build --release --target aarch64-apple-darwin
        env:
          SOURCE_DATE_EPOCH: "1"
          CMAKE_PROJECT_INCLUDE: ${{ format('{0}/cmake/disable-ggml-native.cmake', github.workspace) }}

      - name: Build DMG
        run: |
          mkdir -p dmg-staging
          cp "target/aarch64-apple-darwin/release/oxicrab" dmg-staging/
          cp deploy/com.oxicrab.gateway.plist dmg-staging/
          cp config.example.json dmg-staging/
          cp README.md LICENSE dmg-staging/
          hdiutil create -volname "Oxicrab CI" \
            -srcfolder dmg-staging -ov -format UDZO \
            "oxicrab-ci-arm64.dmg"

      - name: Validate DMG
        run: hdiutil verify "oxicrab-ci-arm64.dmg"

  # ── Fuzz Testing (Informational) ────────────────────────────────
  fuzz:
    name: Fuzz Testing
    needs: [changes]
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.NIGHTLY_VERSION }}

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz --locked

      - name: Cache cargo (fuzz)
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            fuzz/target/
          key: cargo-fuzz-${{ env.NIGHTLY_VERSION }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: cargo-fuzz-${{ env.NIGHTLY_VERSION }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Fuzz webhook signature (30s)
        run: cargo fuzz run fuzz_webhook_signature -- -max_total_time=30
        working-directory: fuzz
        continue-on-error: true

      - name: Fuzz config parse (30s)
        run: cargo fuzz run fuzz_config_parse -- -max_total_time=30
        working-directory: fuzz
        continue-on-error: true

      - name: Fuzz prompt guard (30s)
        run: cargo fuzz run fuzz_prompt_guard -- -max_total_time=30
        working-directory: fuzz
        continue-on-error: true

      - name: Fuzz leak detector (30s)
        run: cargo fuzz run fuzz_leak_detector -- -max_total_time=30
        working-directory: fuzz
        continue-on-error: true

      - name: Fuzz URL validation (30s)
        run: cargo fuzz run fuzz_url_validation -- -max_total_time=30
        working-directory: fuzz
        continue-on-error: true

  # ── CI Gate ─────────────────────────────────────────────────────────
  ci-gate:
    name: CI
    runs-on: ubuntu-latest
    if: always()
    needs: [changes, check, clippy, test-unit, test-integration, compile-debug, coverage, binary-size, package-linux, package-macos]
    steps:
      - name: Check results
        run: |
          echo "changes.code: ${{ needs.changes.outputs.code }}"
          echo "changes.skip: ${{ needs.changes.outputs.skip }}"
          echo "check: ${{ needs.check.result }}"
          echo "clippy: ${{ needs.clippy.result }}"
          echo "test-unit: ${{ needs.test-unit.result }}"
          echo "test-integration: ${{ needs.test-integration.result }}"
          echo "compile-debug: ${{ needs.compile-debug.result }}"
          echo "coverage: ${{ needs.coverage.result }}"
          echo "binary-size: ${{ needs.binary-size.result }}"
          echo "package-linux: ${{ needs.package-linux.result }}"
          echo "package-macos: ${{ needs.package-macos.result }}"

          # check runs unless [no ci] — must pass when it runs
          if [[ "${{ needs.check.result }}" == "failure" || "${{ needs.check.result }}" == "cancelled" ]]; then
            echo "::error::check failed"
            exit 1
          fi

          # Code-gated jobs: fail on failure/cancelled, accept skipped (docs-only changes)
          if [[ "${{ needs.clippy.result }}" == "failure" || "${{ needs.clippy.result }}" == "cancelled" ]]; then
            echo "::error::clippy failed"
            exit 1
          fi
          if [[ "${{ needs.test-unit.result }}" == "failure" || "${{ needs.test-unit.result }}" == "cancelled" ]]; then
            echo "::error::test-unit failed"
            exit 1
          fi
          if [[ "${{ needs.test-integration.result }}" == "failure" || "${{ needs.test-integration.result }}" == "cancelled" ]]; then
            echo "::error::test-integration failed"
            exit 1
          fi
          if [[ "${{ needs.compile-debug.result }}" == "failure" || "${{ needs.compile-debug.result }}" == "cancelled" ]]; then
            echo "::error::compile-debug failed"
            exit 1
          fi

          # Informational jobs — warn but don't block (accept skipped too)
          if [[ "${{ needs.coverage.result }}" == "failure" ]]; then
            echo "::warning::coverage failed (non-blocking)"
          fi
          if [[ "${{ needs.binary-size.result }}" == "failure" ]]; then
            echo "::warning::binary-size failed (non-blocking)"
          fi
          if [[ "${{ needs.package-linux.result }}" == "failure" ]]; then
            echo "::warning::package-linux failed (non-blocking)"
          fi
          if [[ "${{ needs.package-macos.result }}" == "failure" ]]; then
            echo "::warning::package-macos failed (non-blocking)"
          fi
